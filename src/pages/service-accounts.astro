---
import Base from '../layouts/Base.astro';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/');
}

// Get user's API keys from D1
const runtime = Astro.locals.runtime;
let apiKeys: any[] = [];
let autoGeneratedKey: string | null = null;
const userId = user.user_id || user.id;

try {
  const result = await runtime.env.DB.prepare(
    `SELECT id, name, key_prefix, scopes, rate_limit, active, created_at, last_used_at, use_count
     FROM user_api_keys WHERE user_id = ? ORDER BY created_at DESC`
  ).bind(userId).all();
  apiKeys = result.results || [];

  // Auto-generate default API key for new users with no keys
  if (apiKeys.length === 0) {
    const { generateApiKey } = await import('../lib/session');
    const { key, prefix, hash } = await generateApiKey();
    const defaultScopes = ['read', 'write'];

    await runtime.env.DB.prepare(`
      INSERT INTO user_api_keys (user_id, name, key_prefix, key_hash, scopes, rate_limit)
      VALUES (?, ?, ?, ?, ?, ?)
    `).bind(userId, 'Default Access', prefix, hash, JSON.stringify(defaultScopes), 60).run();

    autoGeneratedKey = key;

    // Re-fetch keys to include the new one
    const refreshed = await runtime.env.DB.prepare(
      `SELECT id, name, key_prefix, scopes, rate_limit, active, created_at, last_used_at, use_count
       FROM user_api_keys WHERE user_id = ? ORDER BY created_at DESC`
    ).bind(userId).all();
    apiKeys = refreshed.results || [];
  }
} catch (err) {
  console.error('Failed to fetch/create API keys:', err);
}

function parseScopes(scopes: string | string[]): string[] {
  return typeof scopes === 'string' ? JSON.parse(scopes) : scopes;
}

function maskKey(key: string): string {
  return key.substring(0, 8) + '‚Ä¢'.repeat(Math.max(0, key.length - 12)) + key.substring(key.length - 4);
}
---

<Base title="API Keys" user={user}>
  <a href="/" class="back">‚Üê Back to Dashboard</a>
  <h1>API Keys</h1>
  <p class="subtitle">Manage your API keys for programmatic access to XAOSTECH services</p>
  
  {autoGeneratedKey && (
    <div class="card welcome-key">
      <h3>üéâ Welcome to XAOSTECH!</h3>
      <p style="margin-top: 0.5rem; color: #aaa;">
        We've automatically generated your first API key. <strong>Copy it now</strong> ‚Äî you won't see it again!
      </p>
      <div class="key-display">
        <code id="welcome-key-value" class="masked">{maskKey(autoGeneratedKey)}</code>
        <input type="hidden" id="welcome-key-raw" value={autoGeneratedKey} />
        <div class="key-actions">
          <button class="btn small secondary" id="toggle-welcome-btn">üëÅ Show</button>
          <button class="btn small copy" id="copy-welcome-btn">üìã Copy</button>
        </div>
      </div>
    </div>
  )}
  
  <div class="card">
    <h3>Create New API Key</h3>
    <form id="create-form">
      <div class="form-group">
        <label for="name">Key Name</label>
        <input type="text" id="name" name="name" placeholder="e.g., CI/CD Pipeline" required />
      </div>
      <button type="submit" class="btn primary">Create API Key</button>
    </form>
    <div id="new-key-result" style="display:none; margin-top:1rem;">
      <div class="success-banner">
        <strong>üéâ API Key Created!</strong>
        <p style="margin-top:0.5rem; color:#aaa;">Save this key now - you won't see it again.</p>
      </div>
      <div class="key-display">
        <code id="new-key-value"></code>
        <div class="key-actions">
          <button class="btn small secondary" id="toggle-btn">üëÅ Show</button>
          <button class="btn small copy" id="copy-btn">üìã Copy</button>
        </div>
      </div>
      <input type="hidden" id="new-key-raw" />
    </div>
  </div>

  <h3 style="margin: 2rem 0 1rem;">Your API Keys</h3>
  
  {apiKeys.length === 0 ? (
    <div class="empty">No API keys yet. Create one above to get started.</div>
  ) : (
    apiKeys.map((key: any) => (
      <div class="card key-card">
        <div class="key-name">{key.name}</div>
        <div class="key-meta">
          <code class="key-prefix">{key.key_prefix}...</code> ¬∑ 
          Created: {new Date(key.created_at).toLocaleDateString()} ¬∑ 
          Status: <span class={key.active ? 'status-active' : 'status-inactive'}>
            {key.active ? 'Active' : 'Inactive'}
          </span>
          {key.last_used_at && ` ¬∑ Last used: ${new Date(key.last_used_at).toLocaleDateString()}`}
          {key.use_count > 0 && ` ¬∑ Used: ${key.use_count} times`}
        </div>
        <div class="key-scopes">
          {parseScopes(key.scopes).map((s: string) => (
            <span class="scope">{s}</span>
          ))}
        </div>
        <div class="actions">
          <button 
            class="btn small secondary toggle-key-btn" 
            data-id={key.id} 
            data-active={!key.active}
          >
            {key.active ? 'Disable' : 'Enable'}
          </button>
          <button class="btn small danger delete-key-btn" data-id={key.id}>
            Delete
          </button>
        </div>
      </div>
    ))
  )}
</Base>

<style>
  .back {
    color: var(--primary);
    text-decoration: none;
    display: inline-block;
    margin-bottom: 1rem;
  }
  .back:hover { text-decoration: underline; }
  
  h1 { color: var(--primary); margin-bottom: 0.5rem; }
  .subtitle { color: #888; margin-bottom: 2rem; }
  
  .welcome-key {
    background: linear-gradient(135deg, #1a2a3a, #0a1a2a);
    border: 2px solid var(--primary);
  }
  
  .key-display {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 1rem;
    background: #0a0a0a;
    border-radius: 6px;
    border: 1px solid var(--border);
  }
  .key-display code {
    flex: 1;
    word-break: break-all;
    font-family: monospace;
    font-size: 0.9rem;
  }
  .key-display .masked { color: #666; }
  .key-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .btn.small {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
  .btn.copy { background: #28a745; color: #fff; }
  .btn.danger { background: #dc3545; color: #fff; }
  
  .success-banner {
    background: linear-gradient(135deg, #1a3a1a, #0a2a0a);
    border: 1px solid #2a5a2a;
    padding: 1rem;
    border-radius: 8px;
  }
  
  .empty {
    text-align: center;
    padding: 3rem;
    color: #666;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  
  .key-card { margin-bottom: 1rem; }
  .key-name { font-weight: bold; font-size: 1.1rem; }
  .key-meta { color: #888; font-size: 0.9rem; margin-top: 0.5rem; }
  .key-prefix {
    background: #222;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }
  .key-scopes {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }
  .scope {
    background: #333;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
  }
  
  .actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }
  
  .status-active { color: #28a745; }
  .status-inactive { color: #dc3545; }
</style>

<script>
  // Helper function to mask API keys
  function maskKey(key: string): string {
    return key.substring(0, 8) + '‚Ä¢'.repeat(Math.max(0, key.length - 12)) + key.substring(key.length - 4);
  }

  let keyVisible = false;
  let welcomeKeyVisible = false;

  // Toggle new key visibility
  document.getElementById('toggle-btn')?.addEventListener('click', () => {
    const raw = (document.getElementById('new-key-raw') as HTMLInputElement).value;
    const display = document.getElementById('new-key-value') as HTMLElement;
    const btn = document.getElementById('toggle-btn') as HTMLButtonElement;
    keyVisible = !keyVisible;
    display.textContent = keyVisible ? raw : maskKey(raw);
    display.className = keyVisible ? '' : 'masked';
    btn.textContent = keyVisible ? 'üôà Hide' : 'üëÅ Show';
  });

  // Toggle welcome key visibility
  document.getElementById('toggle-welcome-btn')?.addEventListener('click', () => {
    const rawEl = document.getElementById('welcome-key-raw') as HTMLInputElement;
    if (!rawEl) return;
    const raw = rawEl.value;
    const display = document.getElementById('welcome-key-value') as HTMLElement;
    const btn = document.getElementById('toggle-welcome-btn') as HTMLButtonElement;
    welcomeKeyVisible = !welcomeKeyVisible;
    display.textContent = welcomeKeyVisible ? raw : maskKey(raw);
    display.className = welcomeKeyVisible ? '' : 'masked';
    btn.textContent = welcomeKeyVisible ? 'üôà Hide' : 'üëÅ Show';
  });

  // Copy new key
  document.getElementById('copy-btn')?.addEventListener('click', async (e) => {
    const raw = (document.getElementById('new-key-raw') as HTMLInputElement).value;
    await navigator.clipboard.writeText(raw);
    const btn = e.target as HTMLButtonElement;
    const original = btn.textContent;
    btn.textContent = '‚úì Copied!';
    btn.style.background = '#28a745';
    setTimeout(() => { btn.textContent = original!; btn.style.background = ''; }, 2000);
  });

  // Copy welcome key
  document.getElementById('copy-welcome-btn')?.addEventListener('click', async (e) => {
    const rawEl = document.getElementById('welcome-key-raw') as HTMLInputElement;
    if (!rawEl) return;
    await navigator.clipboard.writeText(rawEl.value);
    const btn = e.target as HTMLButtonElement;
    const original = btn.textContent;
    btn.textContent = '‚úì Copied!';
    btn.style.background = '#28a745';
    setTimeout(() => { btn.textContent = original!; btn.style.background = ''; }, 2000);
  });

  // Create new key form
  document.getElementById('create-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const nameInput = document.getElementById('name') as HTMLInputElement;
    const name = nameInput.value;
    
    try {
      const res = await fetch('/api/keys', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ name, scopes: ['read', 'write'] })
      });
      const data = await res.json();
      if (data.key) {
        (document.getElementById('new-key-raw') as HTMLInputElement).value = data.key;
        (document.getElementById('new-key-value') as HTMLElement).textContent = maskKey(data.key);
        (document.getElementById('new-key-value') as HTMLElement).className = 'masked';
        (document.getElementById('new-key-result') as HTMLElement).style.display = 'block';
        nameInput.value = '';
        keyVisible = false;
      } else {
        alert(data.error || 'Failed to create key');
      }
    } catch {
      alert('Failed to create API key');
    }
  });

  // Delete key buttons
  document.querySelectorAll('.delete-key-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Delete this API key? This cannot be undone.')) return;
      const id = (btn as HTMLElement).dataset.id;
      await fetch('/api/keys/' + id, { method: 'DELETE', credentials: 'include' });
      location.reload();
    });
  });

  // Toggle key active status
  document.querySelectorAll('.toggle-key-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const el = btn as HTMLElement;
      const id = el.dataset.id;
      const newState = el.dataset.active === 'true';
      await fetch('/api/keys/' + id, { 
        method: 'PATCH', 
        credentials: 'include', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ active: newState }) 
      });
      location.reload();
    });
  });
</script>
