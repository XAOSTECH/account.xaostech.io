---
import Base from '../../../layouts/Base.astro';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/login');
}

const childId = Astro.params.id;
const runtime = Astro.locals.runtime;

// Verify parent owns this child
const child = await runtime.env.DB.prepare(`
  SELECT ca.*, u.username as child_username, u.avatar_url as child_avatar,
         pc.content_filter_level, pc.daily_time_limit, pc.weekly_time_limit,
         pc.can_post_content, pc.can_comment, pc.require_approval_for_posts,
         pc.log_exercises, pc.log_logins
  FROM child_accounts ca
  JOIN users u ON ca.child_id = u.id
  LEFT JOIN parental_controls pc ON ca.child_id = pc.child_id
  WHERE ca.parent_id = ? AND ca.child_id = ?
`).bind(user.user_id, childId).first();

if (!child) {
  return Astro.redirect('/family?error=not_found');
}

const url = new URL(Astro.request.url);
const success = url.searchParams.get('success');
---

<Base title={`${child.child_name} Settings`} user={user}>
  <a href="/family" class="back">‚Üê Back to Family Dashboard</a>
  <h1>‚öôÔ∏è {child.child_name}'s Settings</h1>
  <p class="subtitle">@{child.child_username}</p>
  
  {success && (
    <div class="alert alert-success">Settings updated successfully!</div>
  )}
  
  <form method="POST" action={`/api/family/child/${childId}`}>
    <div class="card">
      <h3>üîí Content & Safety</h3>
      
      <div class="form-group">
        <label for="filter_level">Content Filter Level</label>
        <select id="filter_level" name="filter_level">
          <option value="strict" selected={child.content_filter_level === 'strict'}>Strict</option>
          <option value="moderate" selected={child.content_filter_level === 'moderate'}>Moderate</option>
          <option value="minimal" selected={child.content_filter_level === 'minimal'}>Minimal</option>
        </select>
      </div>
    </div>
    
    <div class="card">
      <h3>‚è∞ Time Limits</h3>
      
      <div class="form-row">
        <div class="form-group">
          <label for="daily_limit">Daily Time Limit (minutes)</label>
          <input 
            type="number" 
            id="daily_limit" 
            name="daily_limit" 
            value={child.daily_time_limit || 60} 
            min="0" 
            max="1440"
          />
        </div>
        
        <div class="form-group">
          <label for="weekly_limit">Weekly Time Limit (minutes)</label>
          <input 
            type="number" 
            id="weekly_limit" 
            name="weekly_limit" 
            value={child.weekly_time_limit || 420} 
            min="0" 
            max="10080"
          />
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3>‚úÖ Permissions</h3>
      
      <div class="toggle-group">
        <label class="toggle-row">
          <span>Can create blog posts</span>
          <label class="toggle">
            <input type="checkbox" name="can_post_content" checked={child.can_post_content} />
            <span class="slider"></span>
          </label>
        </label>
        
        <label class="toggle-row">
          <span>Can comment on content</span>
          <label class="toggle">
            <input type="checkbox" name="can_comment" checked={child.can_comment !== false} />
            <span class="slider"></span>
          </label>
        </label>
        
        <label class="toggle-row">
          <span>Require approval for posts</span>
          <label class="toggle">
            <input type="checkbox" name="require_approval_for_posts" checked={child.require_approval_for_posts !== false} />
            <span class="slider"></span>
          </label>
        </label>
      </div>
    </div>
    
    <div class="card">
      <h3>üìä Activity Logging</h3>
      
      <div class="toggle-group">
        <label class="toggle-row">
          <span>Log exercise completions</span>
          <label class="toggle">
            <input type="checkbox" name="log_exercises" checked={child.log_exercises !== false} />
            <span class="slider"></span>
          </label>
        </label>
        
        <label class="toggle-row">
          <span>Log login activity</span>
          <label class="toggle">
            <input type="checkbox" name="log_logins" checked={child.log_logins !== false} />
            <span class="slider"></span>
          </label>
        </label>
      </div>
    </div>
    
    <div class="button-row">
      <button type="submit" class="btn primary">Save Changes</button>
      <a href={`/family/activity/${childId}`} class="btn secondary">View Activity Log</a>
    </div>
  </form>
  
  <div class="card danger-zone">
    <h3>‚ö†Ô∏è Danger Zone</h3>
    <p>Remove this child from your family account. The child account will be converted to a regular account.</p>
    <form method="POST" action={`/api/family/remove-child/${childId}`} onsubmit="return confirm('Are you sure you want to remove this child from your family?')">
      <button type="submit" class="btn danger">Remove from Family</button>
    </form>
  </div>
</Base>

<style>
  .back {
    color: var(--primary);
    text-decoration: none;
    display: inline-block;
    margin-bottom: 1rem;
  }
  .back:hover { text-decoration: underline; }
  
  h1 { color: var(--primary); margin-bottom: 0.5rem; }
  .subtitle { color: #888; margin-bottom: 2rem; }
  
  .alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }
  .alert-success {
    background: rgba(67,160,71,0.1);
    border: 1px solid #43a047;
    color: #43a047;
  }
  
  .card h3 {
    margin-bottom: 1rem;
    color: var(--primary);
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  .toggle-group {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .toggle-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  
  .toggle {
    position: relative;
    width: 50px;
    height: 26px;
    display: inline-block;
  }
  .toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .toggle .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: #333;
    border-radius: 26px;
    transition: 0.3s;
  }
  .toggle .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background: #666;
    border-radius: 50%;
    transition: 0.3s;
  }
  .toggle input:checked + .slider {
    background: var(--primary);
  }
  .toggle input:checked + .slider:before {
    transform: translateX(24px);
    background: #fff;
  }
  
  .button-row {
    display: flex;
    gap: 1rem;
    margin: 1.5rem 0;
  }
  
  .danger-zone {
    border-color: #5a2a2a;
    margin-top: 2rem;
  }
  .danger-zone h3 {
    color: #e53935;
  }
  .danger-zone p {
    color: #888;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }
  
  .btn.danger {
    background: transparent;
    border: 1px solid #e53935;
    color: #e53935;
  }
  .btn.danger:hover {
    background: rgba(229,57,53,0.1);
  }
  
  @media (max-width: 500px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
