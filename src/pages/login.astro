---
/**
 * Login Page
 */
import Base from '../layouts/Base.astro';

const error = Astro.url.searchParams.get('error') || '';
const success = Astro.url.searchParams.get('success') || '';

// Redirect if already logged in
if (Astro.locals.user) {
  return Astro.redirect('/');
}
---
<Base title="Sign In" showNav={false}>
  <div style="max-width:400px;margin:2rem auto">
    <h1 style="color:var(--primary);margin-bottom:0.5rem;font-size:1.75rem;text-align:center">üîê Sign In</h1>
    <p style="text-align:center;color:var(--text-muted);margin-bottom:2rem">Welcome back to XAOSTECH</p>

    <div class="card">
      {error && <div class="message message-error">{error}</div>}
      {success && <div class="message message-success">{success}</div>}

      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required autocomplete="current-password" />
        </div>
        <button type="submit" class="btn-primary" style="width:100%">Sign In</button>
      </form>

      <div style="margin-top:1.5rem;text-align:center">
        <a href="/forgot-password">Forgot password?</a>
      </div>

      <div style="display:flex;align-items:center;margin:1.5rem 0;color:var(--text-muted)">
        <div style="flex:1;border-bottom:1px solid var(--border)"></div>
        <span style="padding:0 1rem;font-size:0.9rem">or</span>
        <div style="flex:1;border-bottom:1px solid var(--border)"></div>
      </div>

      <a href="https://api.xaostech.io/auth/github/login" 
         style="display:flex;justify-content:center;align-items:center;gap:0.5rem;background:#24292e;color:#fff;padding:0.75rem;border-radius:8px;text-decoration:none;font-weight:500">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577v-2.165c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.09-.744.083-.729.083-.729 1.205.084 1.84 1.236 1.84 1.236 1.07 1.835 2.807 1.305 3.492.998.108-.775.42-1.305.763-1.605-2.665-.3-5.467-1.332-5.467-5.93 0-1.31.468-2.382 1.236-3.222-.124-.303-.536-1.524.117-3.176 0 0 1.008-.322 3.3 1.23A11.5 11.5 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.29-1.552 3.297-1.23 3.297-1.23.653 1.652.242 2.873.118 3.176.77.84 1.235 1.912 1.235 3.222 0 4.61-2.807 5.625-5.48 5.92.43.372.824 1.102.824 2.222v3.293c0 .322.218.694.825.576C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12z"/>
        </svg>
        Continue with GitHub
      </a>

      <div style="margin-top:1.5rem;text-align:center">
        Don't have an account? <a href="/register">Sign up</a>
      </div>
    </div>

    <footer style="margin-top:2rem;text-align:center;color:var(--text-muted)">
      <a href="/">‚Üê Back to Account</a>
    </footer>
  </div>
</Base>

<script>
  document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;
    try {
      const res = await fetch('https://api.xaostech.io/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password }),
        credentials: 'include'
      });
      const data = await res.json();
      if (res.ok) {
        window.location.href = '/';
      } else {
        window.location.href = '/login?error=' + encodeURIComponent(data.error || 'Login failed');
      }
    } catch (err) {
      window.location.href = '/login?error=' + encodeURIComponent('Network error');
    }
  });
</script>
