---
/**
 * Register Page
 */
import Base from '../layouts/Base.astro';

const error = Astro.url.searchParams.get('error') || '';

// Redirect if already logged in
if (Astro.locals.user) {
  return Astro.redirect('/');
}
---
<Base title="Create Account" showNav={false}>
  <div style="max-width:400px;margin:2rem auto">
    <h1 style="color:var(--primary);margin-bottom:0.5rem;font-size:1.75rem;text-align:center">üöÄ Create Account</h1>
    <p style="text-align:center;color:var(--text-muted);margin-bottom:2rem">Join XAOSTECH to access our platform</p>

    <div class="card">
      {error && <div class="message message-error">{error}</div>}

      <form id="registerForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required pattern="^[a-zA-Z0-9_-]+$" minlength="3" maxlength="30" />
          <p style="font-size:0.8rem;color:var(--text-muted);margin-top:0.25rem">Letters, numbers, underscores, hyphens only</p>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required minlength="8" />
          <p style="font-size:0.8rem;color:var(--text-muted);margin-top:0.25rem">8+ characters, at least one uppercase letter and number</p>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" name="confirmPassword" required />
        </div>
        <button type="submit" class="btn-primary" style="width:100%" id="submitBtn">Create Account</button>
      </form>

      <div style="display:flex;align-items:center;margin:1.5rem 0;color:var(--text-muted)">
        <div style="flex:1;border-bottom:1px solid var(--border)"></div>
        <span style="padding:0 1rem;font-size:0.9rem">or</span>
        <div style="flex:1;border-bottom:1px solid var(--border)"></div>
      </div>

      <a href="https://api.xaostech.io/auth/github/login" 
         style="display:flex;justify-content:center;align-items:center;gap:0.5rem;background:#24292e;color:#fff;padding:0.75rem;border-radius:8px;text-decoration:none;font-weight:500">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577v-2.165c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.09-.744.083-.729.083-.729 1.205.084 1.84 1.236 1.84 1.236 1.07 1.835 2.807 1.305 3.492.998.108-.775.42-1.305.763-1.605-2.665-.3-5.467-1.332-5.467-5.93 0-1.31.468-2.382 1.236-3.222-.124-.303-.536-1.524.117-3.176 0 0 1.008-.322 3.3 1.23A11.5 11.5 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.29-1.552 3.297-1.23 3.297-1.23.653 1.652.242 2.873.118 3.176.77.84 1.235 1.912 1.235 3.222 0 4.61-2.807 5.625-5.48 5.92.43.372.824 1.102.824 2.222v3.293c0 .322.218.694.825.576C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12z"/>
        </svg>
        Continue with GitHub
      </a>

      <div style="margin-top:1.5rem;text-align:center">
        Already have an account? <a href="/login">Sign in</a>
      </div>
    </div>

    <footer style="margin-top:2rem;text-align:center;color:var(--text-muted)">
      <a href="/">‚Üê Back to Account</a>
    </footer>
  </div>

  <!-- Success Modal -->
  <div id="successModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;z-index:100">
    <div style="background:var(--bg-card);padding:2rem;border-radius:12px;max-width:400px;text-align:center">
      <h2 style="color:var(--success);margin-bottom:1rem">‚úÖ Check Your Email</h2>
      <p style="margin-bottom:1.5rem;line-height:1.6">We've sent a verification link to your email address. Please click the link to verify your account before logging in.</p>
      <a href="/login" class="btn-primary" style="display:inline-block;padding:0.75rem 2rem;border-radius:8px;text-decoration:none">Go to Login</a>
    </div>
  </div>
</Base>

<script>
  document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = (document.getElementById('username') as HTMLInputElement).value;
    const email = (document.getElementById('email') as HTMLInputElement).value;
    const password = (document.getElementById('password') as HTMLInputElement).value;
    const confirmPassword = (document.getElementById('confirmPassword') as HTMLInputElement).value;

    if (password !== confirmPassword) {
      window.location.href = '/register?error=' + encodeURIComponent('Passwords do not match');
      return;
    }

    if (!/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
      window.location.href = '/register?error=' + encodeURIComponent('Password must contain uppercase letter and number');
      return;
    }

    const btn = document.getElementById('submitBtn') as HTMLButtonElement;
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
      const res = await fetch('https://api.xaostech.io/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email, password })
      });
      const data = await res.json();
      if (res.ok) {
        const modal = document.getElementById('successModal');
        if (modal) modal.style.display = 'flex';
      } else {
        window.location.href = '/register?error=' + encodeURIComponent(data.error || 'Registration failed');
      }
    } catch (err) {
      window.location.href = '/register?error=' + encodeURIComponent('Network error');
    }
  });
</script>
